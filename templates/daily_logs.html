
{% extends 'base.html' %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-dark">Daily Logs for {{ resident.name }}</h1>
            <p class="lead text-muted">{{ log_date.strftime('%A, %B %d, %Y') }}</p>
        </div>
    </div>

    <!-- Date Navigation -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{{ url_for('daily_logs', resident_id=resident.id, date=prev_date) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i> Previous Day
                </a>
                <span class="fw-bold">{{ log_date.strftime('%B %d, %Y') }}</span>
                <a href="{{ url_for('daily_logs', resident_id=resident.id, date=next_date) }}" class="btn btn-outline-secondary">
                    Next Day <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Meal Selection Cards -->
    <div class="row mb-4">
        {% for meal_type in ['breakfast', 'lunch', 'dinner'] %}
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100 meal-card" data-meal="{{ meal_type }}">
                <div class="card-body text-center">
                    <div class="meal-icon mb-3">
                        {% if meal_type == 'breakfast' %}
                            <i class="bi bi-cup-hot" style="font-size: 3rem; color: #ff6b35;"></i>
                        {% elif meal_type == 'lunch' %}
                            <i class="bi bi-bowl-rice" style="font-size: 3rem; color: #f7931e;"></i>
                        {% else %}
                            <i class="bi bi-moon-stars" style="font-size: 3rem; color: #6b48ff;"></i>
                        {% endif %}
                    </div>
                    <h3 class="card-title">{{ meal_type.title() }}</h3>
                    
                    <!-- Progress indicators -->
                    <div class="meal-progress mb-3">
                        {% set meal_food = food_intakes | selectattr('meal_type', 'equalto', meal_type) | list %}
                        {% set meal_liquid = liquid_intakes | selectattr('meal_type', 'equalto', meal_type) | list %}
                        {% set meal_bowel = bowel_movements | selectattr('meal_type', 'equalto', meal_type) | list %}
                        {% set meal_urine = urine_outputs | selectattr('meal_type', 'equalto', meal_type) | list %}
                        {% set vitals_recorded = vitals and meal_type == 'breakfast' %}
                        
                        {% set total_steps = 6 if meal_type == 'breakfast' else 5 %}
                        {% set completed_steps = 0 %}
                        {% if meal_type == 'breakfast' and vitals_recorded %}
                            {% set completed_steps = completed_steps + 1 %}
                        {% endif %}
                        {% if meal_food %}
                            {% set completed_steps = completed_steps + 1 %}
                        {% endif %}
                        {% if meal_liquid | length >= 3 %}
                            {% set completed_steps = completed_steps + 1 %}
                        {% endif %}
                        {% if meal_bowel %}
                            {% set completed_steps = completed_steps + 1 %}
                        {% endif %}
                        {% if meal_urine %}
                            {% set completed_steps = completed_steps + 1 %}
                        {% endif %}
                        
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ (completed_steps / total_steps) * 100 }}%">
                                {{ completed_steps }}/{{ total_steps }}
                            </div>
                        </div>
                        
                        <div class="step-indicators">
                            {% if meal_type == 'breakfast' %}
                                <span class="badge {{ 'bg-success' if vitals_recorded else 'bg-secondary' }} me-1">Vitals</span>
                            {% endif %}
                            <span class="badge {{ 'bg-success' if meal_food else 'bg-secondary' }} me-1">Food</span>
                            <span class="badge {{ 'bg-success' if meal_liquid | length >= 3 else 'bg-secondary' }} me-1">Liquids ({{ meal_liquid | length }}/3)</span>
                            <span class="badge {{ 'bg-success' if meal_bowel else 'bg-secondary' }} me-1">Bowel</span>
                            <span class="badge {{ 'bg-success' if meal_urine else 'bg-secondary' }} me-1">Urine</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-lg w-100 start-meal-btn" data-meal="{{ meal_type }}">
                        {% if completed_steps == total_steps %}
                            <i class="bi bi-check-circle me-2"></i>Review & Edit
                        {% else %}
                            <i class="bi bi-play-circle me-2"></i>Start Logging
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Step-by-Step Wizard Modal -->
    <div class="modal fade" id="mealWizardModal" tabindex="-1" aria-labelledby="mealWizardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mealWizardModalLabel">Daily Log Wizard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 30px;" id="wizardProgress">
                        <div class="progress-bar" role="progressbar" style="width: 0%">
                            <span id="progressText">Step 1 of 5</span>
                        </div>
                    </div>
                    
                    <!-- Form Container -->
                    <form id="mealWizardForm">
                        <input type="hidden" id="currentMeal" name="meal_type" value="">
                        <input type="hidden" id="currentStep" name="step" value="1">
                        
                        <!-- Step Content -->
                        <div id="stepContent">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        
                        <!-- Navigation Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
                                <i class="bi bi-chevron-left"></i> Previous
                            </button>
                            <div class="ms-auto">
                                <button type="button" class="btn btn-outline-primary me-2" id="skipBtn">Skip</button>
                                <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
                                <button type="button" class="btn btn-success" id="submitBtn" style="display: none;">
                                    <i class="bi bi-check-circle me-2"></i>Complete
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class MealWizard {
    constructor() {
        this.currentMeal = '';
        this.currentStep = 1;
        this.totalSteps = 5;
        this.formData = {};
        this.stepDefinitions = {
            breakfast: [
                { id: 1, name: 'Vitals', required: true },
                { id: 2, name: 'Food Intake', required: true },
                { id: 3, name: 'Liquid Intake', required: true },
                { id: 4, name: 'Bowel Movement', required: true },
                { id: 5, name: 'Urine Output', required: true }
            ],
            lunch: [
                { id: 2, name: 'Food Intake', required: true },
                { id: 3, name: 'Liquid Intake', required: true },
                { id: 4, name: 'Bowel Movement', required: true },
                { id: 5, name: 'Urine Output', required: true }
            ],
            dinner: [
                { id: 2, name: 'Food Intake', required: true },
                { id: 3, name: 'Liquid Intake', required: true },
                { id: 4, name: 'Bowel Movement', required: true },
                { id: 5, name: 'Urine Output', required: true }
            ]
        };
        this.init();
    }

    init() {
        // Meal card click handlers
        const startMealBtns = document.querySelectorAll('.start-meal-btn');
        if (startMealBtns) {
            startMealBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const meal = e.target.dataset.meal;
                    this.startMealWizard(meal);
                });
            });
        }

        // Wizard navigation
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const skipBtn = document.getElementById('skipBtn');
        const submitBtn = document.getElementById('submitBtn');

        if (nextBtn) nextBtn.addEventListener('click', () => this.nextStep());
        if (prevBtn) prevBtn.addEventListener('click', () => this.prevStep());
        if (skipBtn) skipBtn.addEventListener('click', () => this.skipStep());
        if (submitBtn) submitBtn.addEventListener('click', () => this.submitForm());
    }

    startMealWizard(meal) {
        this.currentMeal = meal;
        this.currentStep = 1;
        this.formData = {};
        this.totalSteps = this.stepDefinitions[meal].length;
        
        const currentMealInput = document.getElementById('currentMeal');
        const currentStepInput = document.getElementById('currentStep');
        
        if (currentMealInput) currentMealInput.value = meal;
        if (currentStepInput) currentStepInput.value = '1';
        
        this.renderStep();
        this.updateProgress();
        
        const modalElement = document.getElementById('mealWizardModal');
        if (modalElement && typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    }

    renderStep() {
        const stepContent = document.getElementById('stepContent');
        if (!stepContent) return;
        
        const steps = this.stepDefinitions[this.currentMeal];
        const step = steps[this.currentStep - 1];
        
        let html = `<h4 class="mb-3">${step.name} - ${this.currentMeal.charAt(0).toUpperCase() + this.currentMeal.slice(1)}</h4>`;
        
        switch(step.id) {
            case 1: // Vitals
                html += `
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Systolic Blood Pressure</label>
                            <input type="number" class="form-control" id="systolic" name="systolic" 
                                   placeholder="e.g., 120" value="${this.formData.systolic || ''}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Diastolic Blood Pressure</label>
                            <input type="number" class="form-control" id="diastolic" name="diastolic" 
                                   placeholder="e.g., 80" value="${this.formData.diastolic || ''}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Pulse</label>
                            <input type="number" class="form-control" id="pulse" name="pulse" 
                                   placeholder="e.g., 70" value="${this.formData.pulse || ''}">
                        </div>
                    </div>
                `;
                break;
            case 2: // Food Intake
                html += `
                    <div class="mb-3">
                        <label class="form-label">Food Intake Level</label>
                        <select class="form-select" id="intake_level" name="intake_level">
                            <option value="">Select intake level...</option>
                            <option value="25%" ${this.formData.intake_level === '25%' ? 'selected' : ''}>25%</option>
                            <option value="50%" ${this.formData.intake_level === '50%' ? 'selected' : ''}>50%</option>
                            <option value="75%" ${this.formData.intake_level === '75%' ? 'selected' : ''}>75%</option>
                            <option value="100%" ${this.formData.intake_level === '100%' ? 'selected' : ''}>100%</option>
                            <option value="Ensure" ${this.formData.intake_level === 'Ensure' ? 'selected' : ''}>Ensure</option>
                            <option value="Other" ${this.formData.intake_level === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="mb-3" id="notesContainer" style="display: ${this.formData.intake_level === 'Other' ? 'block' : 'none'};">
                        <label class="form-label">Notes (for Other)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3">${this.formData.notes || ''}</textarea>
                    </div>
                `;
                break;
            case 3: // Liquid Intake - Multiple liquids
                html += `
                    <div class="mb-3">
                        <label class="form-label">Liquid Intake (3 entries required)</label>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Liquid 1</label>
                                <select class="form-select" id="liquid_1" name="liquid_1">
                                    <option value="">Select liquid intake...</option>
                                    <option value="Yes" ${this.formData.liquid_1 === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${this.formData.liquid_1 === 'No' ? 'selected' : ''}>No</option>
                                    <option value="Partial" ${this.formData.liquid_1 === 'Partial' ? 'selected' : ''}>Partial</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Liquid 2</label>
                                <select class="form-select" id="liquid_2" name="liquid_2">
                                    <option value="">Select liquid intake...</option>
                                    <option value="Yes" ${this.formData.liquid_2 === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${this.formData.liquid_2 === 'No' ? 'selected' : ''}>No</option>
                                    <option value="Partial" ${this.formData.liquid_2 === 'Partial' ? 'selected' : ''}>Partial</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Liquid 3</label>
                                <select class="form-select" id="liquid_3" name="liquid_3">
                                    <option value="">Select liquid intake...</option>
                                    <option value="Yes" ${this.formData.liquid_3 === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${this.formData.liquid_3 === 'No' ? 'selected' : ''}>No</option>
                                    <option value="Partial" ${this.formData.liquid_3 === 'Partial' ? 'selected' : ''}>Partial</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 4: // Bowel Movement
                html += `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Size</label>
                            <select class="form-select" id="size" name="size">
                                <option value="">Select size...</option>
                                <option value="Small" ${this.formData.size === 'Small' ? 'selected' : ''}>Small</option>
                                <option value="Medium" ${this.formData.size === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Large" ${this.formData.size === 'Large' ? 'selected' : ''}>Large</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Consistency</label>
                            <select class="form-select" id="consistency" name="consistency">
                                <option value="">Select consistency...</option>
                                <option value="Soft" ${this.formData.consistency === 'Soft' ? 'selected' : ''}>Soft</option>
                                <option value="Medium" ${this.formData.consistency === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Hard" ${this.formData.consistency === 'Hard' ? 'selected' : ''}>Hard</option>
                            </select>
                        </div>
                    </div>
                `;
                break;
            case 5: // Urine Output
                html += `
                    <div class="mb-3">
                        <label class="form-label">Urine Output</label>
                        <select class="form-select" id="urine_output" name="urine_output">
                            <option value="">Select urine output...</option>
                            <option value="Yes" ${this.formData.urine_output === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${this.formData.urine_output === 'No' ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                `;
                break;
        }
        
        stepContent.innerHTML = html;
        
        // Add event listeners for dynamic elements
        if (step.id === 2) {
            const intakeSelect = document.getElementById('intake_level');
            if (intakeSelect) {
                intakeSelect.addEventListener('change', (e) => {
                    const notesContainer = document.getElementById('notesContainer');
                    if (notesContainer) {
                        notesContainer.style.display = e.target.value === 'Other' ? 'block' : 'none';
                    }
                });
            }
        }
    }

    updateProgress() {
        const progress = (this.currentStep / this.totalSteps) * 100;
        const progressBar = document.querySelector('#wizardProgress .progress-bar');
        const progressText = document.getElementById('progressText');
        
        if (progressBar) progressBar.style.width = progress + '%';
        if (progressText) progressText.textContent = `Step ${this.currentStep} of ${this.totalSteps}`;
        
        // Update navigation buttons
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        if (prevBtn) prevBtn.style.display = this.currentStep > 1 ? 'inline-block' : 'none';
        if (nextBtn) nextBtn.style.display = this.currentStep < this.totalSteps ? 'inline-block' : 'none';
        if (submitBtn) submitBtn.style.display = this.currentStep === this.totalSteps ? 'inline-block' : 'none';
    }

    saveCurrentStep() {
        const steps = this.stepDefinitions[this.currentMeal];
        const step = steps[this.currentStep - 1];
        
        switch(step.id) {
            case 1: // Vitals
                const systolic = document.getElementById('systolic');
                const diastolic = document.getElementById('diastolic');
                const pulse = document.getElementById('pulse');
                
                if (systolic) this.formData.systolic = systolic.value;
                if (diastolic) this.formData.diastolic = diastolic.value;
                if (pulse) this.formData.pulse = pulse.value;
                break;
            case 2: // Food Intake
                const intakeLevel = document.getElementById('intake_level');
                const notes = document.getElementById('notes');
                
                if (intakeLevel) this.formData.intake_level = intakeLevel.value;
                if (notes) this.formData.notes = notes.value;
                break;
            case 3: // Liquid Intake
                const liquid1 = document.getElementById('liquid_1');
                const liquid2 = document.getElementById('liquid_2');
                const liquid3 = document.getElementById('liquid_3');
                
                if (liquid1) this.formData.liquid_1 = liquid1.value;
                if (liquid2) this.formData.liquid_2 = liquid2.value;
                if (liquid3) this.formData.liquid_3 = liquid3.value;
                break;
            case 4: // Bowel Movement
                const size = document.getElementById('size');
                const consistency = document.getElementById('consistency');
                
                if (size) this.formData.size = size.value;
                if (consistency) this.formData.consistency = consistency.value;
                break;
            case 5: // Urine Output
                const urineOutput = document.getElementById('urine_output');
                
                if (urineOutput) this.formData.urine_output = urineOutput.value;
                break;
        }
    }

    nextStep() {
        this.saveCurrentStep();
        if (this.currentStep < this.totalSteps) {
            this.currentStep++;
            this.renderStep();
            this.updateProgress();
        }
    }

    prevStep() {
        this.saveCurrentStep();
        if (this.currentStep > 1) {
            this.currentStep--;
            this.renderStep();
            this.updateProgress();
        }
    }

    skipStep() {
        if (this.currentStep < this.totalSteps) {
            this.currentStep++;
            this.renderStep();
            this.updateProgress();
        }
    }

    async submitForm() {
        this.saveCurrentStep();
        
        const formData = new FormData();
        formData.append('meal_type', this.currentMeal);
        formData.append('form_data', JSON.stringify(this.formData));
        
        const csrfToken = document.querySelector('[name=csrf_token]');
        if (!csrfToken) {
            alert('CSRF token not found. Please refresh the page.');
            return;
        }
        
        try {
            const response = await fetch(`/resident/{{ resident.id }}/daily-log-submit`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken.value
                }
            });
            
            if (response.ok) {
                const modalElement = document.getElementById('mealWizardModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                }
                location.reload(); // Refresh to show updated data
            } else {
                alert('Error saving data. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving data. Please try again.');
        }
    }
}

// Initialize the wizard when the page loads
document.addEventListener('DOMContentLoaded', function() {
    new MealWizard();
});
</script>
{% endblock %}

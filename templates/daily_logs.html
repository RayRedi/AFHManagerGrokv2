{% extends "base.html" %}
{% block title %}Daily Logs - {{ resident.name }}{% endblock %}
{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 fw-bold text-dark">Daily Logs for {{ resident.name }}</h1>
        <p class="lead text-muted">Complete daily logging for meals and activities.</p>
    </div>
</div>

<!-- Meal Selection Cards -->
<div class="row g-4 mb-4">
    <!-- Breakfast Card -->
    <div class="col-12 col-md-4">
        <div class="card meal-card h-100 shadow-sm" onclick="openMealWizard('breakfast')">
            <div class="card-body text-center">
                <div class="meal-icon mb-3">
                    <i class="fas fa-sun" style="font-size: 3rem; color: #ffc107;"></i>
                </div>
                <h3 class="card-title fw-bold">Breakfast</h3>
                <div class="meal-progress mb-3">
                    <div class="progress">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="step-indicators">
                    <span class="badge bg-secondary me-1">Vitals</span>
                    <span class="badge bg-secondary me-1">Food</span>
                    <span class="badge bg-secondary me-1">Liquid 1</span>
                    <span class="badge bg-secondary me-1">Liquid 2</span>
                    <span class="badge bg-secondary me-1">Liquid 3</span>
                    <span class="badge bg-secondary me-1">Bowel</span>
                    <span class="badge bg-secondary">Urine</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Lunch Card -->
    <div class="col-12 col-md-4">
        <div class="card meal-card h-100 shadow-sm" onclick="openMealWizard('lunch')">
            <div class="card-body text-center">
                <div class="meal-icon mb-3">
                    <i class="fas fa-sun" style="font-size: 3rem; color: #fd7e14;"></i>
                </div>
                <h3 class="card-title fw-bold">Lunch</h3>
                <div class="meal-progress mb-3">
                    <div class="progress">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="step-indicators">
                    <span class="badge bg-secondary me-1">Food</span>
                    <span class="badge bg-secondary me-1">Liquid 1</span>
                    <span class="badge bg-secondary me-1">Liquid 2</span>
                    <span class="badge bg-secondary me-1">Liquid 3</span>
                    <span class="badge bg-secondary me-1">Bowel</span>
                    <span class="badge bg-secondary">Urine</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Dinner Card -->
    <div class="col-12 col-md-4">
        <div class="card meal-card h-100 shadow-sm" onclick="openMealWizard('dinner')">
            <div class="card-body text-center">
                <div class="meal-icon mb-3">
                    <i class="fas fa-moon" style="font-size: 3rem; color: #6f42c1;"></i>
                </div>
                <h3 class="card-title fw-bold">Dinner</h3>
                <div class="meal-progress mb-3">
                    <div class="progress">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="step-indicators">
                    <span class="badge bg-secondary me-1">Food</span>
                    <span class="badge bg-secondary me-1">Liquid 1</span>
                    <span class="badge bg-secondary me-1">Liquid 2</span>
                    <span class="badge bg-secondary me-1">Liquid 3</span>
                    <span class="badge bg-secondary me-1">Bowel</span>
                    <span class="badge bg-secondary">Urine</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wizard Modal -->
<div class="modal fade" id="mealWizardModal" tabindex="-1" aria-labelledby="mealWizardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mealWizardModalLabel">Daily Log Wizard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div id="wizardProgress" class="progress">
                        <div class="progress-bar" style="width: 0%">
                            <span id="progressText">Step 1 of 7</span>
                        </div>
                    </div>
                </div>

                <!-- Step Content -->
                <div id="stepContent">
                    <!-- Content will be dynamically generated -->
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between">
                    <button type="button" id="prevBtn" class="btn btn-outline-secondary" style="display: none;">Previous</button>
                    <div>
                        <button type="button" id="skipBtn" class="btn btn-outline-primary me-2">Skip</button>
                        <button type="button" id="nextBtn" class="btn btn-primary">Next</button>
                        <button type="button" id="submitBtn" class="btn btn-success" style="display: none;">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class DailyLogWizard {
    constructor() {
        this.currentMeal = '';
        this.currentStep = 1;
        this.totalSteps = 7;
        this.formData = {};

        this.stepDefinitions = {
            'breakfast': [
                { id: 1, name: 'Vitals', required: false },
                { id: 2, name: 'Food Intake', required: true },
                { id: 3, name: 'Liquid 1', required: true },
                { id: 4, name: 'Liquid 2', required: true },
                { id: 5, name: 'Liquid 3', required: true },
                { id: 6, name: 'Bowel Movement', required: true },
                { id: 7, name: 'Urine Output', required: true }
            ],
            'lunch': [
                { id: 2, name: 'Food Intake', required: true },
                { id: 3, name: 'Liquid 1', required: true },
                { id: 4, name: 'Liquid 2', required: true },
                { id: 5, name: 'Liquid 3', required: true },
                { id: 6, name: 'Bowel Movement', required: true },
                { id: 7, name: 'Urine Output', required: true }
            ],
            'dinner': [
                { id: 2, name: 'Food Intake', required: true },
                { id: 3, name: 'Liquid 1', required: true },
                { id: 4, name: 'Liquid 2', required: true },
                { id: 5, name: 'Liquid 3', required: true },
                { id: 6, name: 'Bowel Movement', required: true },
                { id: 7, name: 'Urine Output', required: true }
            ]
        };
    }

    startWizard(meal) {
        this.currentMeal = meal;
        this.currentStep = 1;
        this.totalSteps = this.stepDefinitions[meal].length;
        this.formData = {};

        const modalTitle = document.getElementById('mealWizardModalLabel');
        if (modalTitle) {
            modalTitle.textContent = `${meal.charAt(0).toUpperCase() + meal.slice(1)} Log`;
        }

        this.renderStep();
        this.updateProgress();
        this.attachEventListeners();
    }

    renderStep() {
        const stepContent = document.getElementById('stepContent');
        if (!stepContent) return;

        const steps = this.stepDefinitions[this.currentMeal];
        const step = steps[this.currentStep - 1];

        let html = `<h4>${step.name}</h4>`;

        switch(step.id) {
            case 1: // Vitals
                html += `
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="systolic" class="form-label">Systolic BP</label>
                            <input type="number" class="form-control" id="systolic" value="${this.formData.systolic || ''}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="diastolic" class="form-label">Diastolic BP</label>
                            <input type="number" class="form-control" id="diastolic" value="${this.formData.diastolic || ''}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="pulse" class="form-label">Pulse</label>
                            <input type="number" class="form-control" id="pulse" value="${this.formData.pulse || ''}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="vitals_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="vitals_notes" rows="3">${this.formData.vitals_notes || ''}</textarea>
                    </div>
                `;
                break;
            case 2: // Food Intake
                html += `
                    <div class="mb-3">
                        <label for="intake_level" class="form-label">Food Intake Level</label>
                        <select class="form-select" id="intake_level">
                            <option value="">Select intake level</option>
                            <option value="25%" ${this.formData.intake_level === '25%' ? 'selected' : ''}>25%</option>
                            <option value="50%" ${this.formData.intake_level === '50%' ? 'selected' : ''}>50%</option>
                            <option value="75%" ${this.formData.intake_level === '75%' ? 'selected' : ''}>75%</option>
                            <option value="100%" ${this.formData.intake_level === '100%' ? 'selected' : ''}>100%</option>
                            <option value="Ensure" ${this.formData.intake_level === 'Ensure' ? 'selected' : ''}>Ensure</option>
                            <option value="Other" ${this.formData.intake_level === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="food_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="food_notes" rows="3">${this.formData.food_notes || ''}</textarea>
                    </div>
                `;
                break;
            case 3: // Liquid 1
            case 4: // Liquid 2  
            case 5: // Liquid 3
                const liquidNum = step.id - 2;
                html += `
                    <div class="mb-3">
                        <label for="liquid${liquidNum}_type" class="form-label">Liquid Type</label>
                        <input type="text" class="form-control" id="liquid${liquidNum}_type" value="${this.formData[`liquid${liquidNum}_type`] || ''}">
                    </div>
                    <div class="mb-3">
                        <label for="liquid${liquidNum}_amount" class="form-label">Amount</label>
                        <input type="text" class="form-control" id="liquid${liquidNum}_amount" value="${this.formData[`liquid${liquidNum}_amount`] || ''}">
                    </div>
                    <div class="mb-3">
                        <label for="liquid${liquidNum}_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="liquid${liquidNum}_notes" rows="3">${this.formData[`liquid${liquidNum}_notes`] || ''}</textarea>
                    </div>
                `;
                break;
            case 6: // Bowel Movement
                html += `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bowel_size" class="form-label">Size</label>
                            <select class="form-select" id="bowel_size">
                                <option value="">Select size</option>
                                <option value="Small" ${this.formData.bowel_size === 'Small' ? 'selected' : ''}>Small</option>
                                <option value="Medium" ${this.formData.bowel_size === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Large" ${this.formData.bowel_size === 'Large' ? 'selected' : ''}>Large</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bowel_consistency" class="form-label">Consistency</label>
                            <select class="form-select" id="bowel_consistency">
                                <option value="">Select consistency</option>
                                <option value="Soft" ${this.formData.bowel_consistency === 'Soft' ? 'selected' : ''}>Soft</option>
                                <option value="Medium" ${this.formData.bowel_consistency === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Hard" ${this.formData.bowel_consistency === 'Hard' ? 'selected' : ''}>Hard</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bowel_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="bowel_notes" rows="3">${this.formData.bowel_notes || ''}</textarea>
                    </div>
                `;
                break;
            case 7: // Urine Output
                html += `
                    <div class="mb-3">
                        <label for="urine_output" class="form-label">Urine Output</label>
                        <select class="form-select" id="urine_output">
                            <option value="">Select output</option>
                            <option value="Yes" ${this.formData.urine_output === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${this.formData.urine_output === 'No' ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="urine_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="urine_notes" rows="3">${this.formData.urine_notes || ''}</textarea>
                    </div>
                `;
                break;
        }

        stepContent.innerHTML = html;
        this.updateNavigationButtons();
    }

    updateProgress() {
        const progressBar = document.querySelector('#wizardProgress .progress-bar');
        const progressText = document.getElementById('progressText');

        if (progressBar && progressText) {
            const percentage = (this.currentStep / this.totalSteps) * 100;
            progressBar.style.width = percentage + '%';
            progressText.textContent = `Step ${this.currentStep} of ${this.totalSteps}`;
        }
    }

    updateNavigationButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        if (prevBtn) prevBtn.style.display = this.currentStep > 1 ? 'inline-block' : 'none';
        if (nextBtn) nextBtn.style.display = this.currentStep < this.totalSteps ? 'inline-block' : 'none';
        if (submitBtn) submitBtn.style.display = this.currentStep === this.totalSteps ? 'inline-block' : 'none';
    }

    attachEventListeners() {
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const skipBtn = document.getElementById('skipBtn');
        const submitBtn = document.getElementById('submitBtn');

        if (nextBtn) {
            nextBtn.onclick = () => this.nextStep();
        }
        if (prevBtn) {
            prevBtn.onclick = () => this.prevStep();
        }
        if (skipBtn) {
            skipBtn.onclick = () => this.skipStep();
        }
        if (submitBtn) {
            submitBtn.onclick = () => this.submitForm();
        }
    }

    saveCurrentStep() {
        const steps = this.stepDefinitions[this.currentMeal];
        const step = steps[this.currentStep - 1];

        switch(step.id) {
            case 1: // Vitals
                const systolic = document.getElementById('systolic');
                const diastolic = document.getElementById('diastolic');
                const pulse = document.getElementById('pulse');
                const vitalsNotes = document.getElementById('vitals_notes');

                if (systolic) this.formData.systolic = systolic.value;
                if (diastolic) this.formData.diastolic = diastolic.value;
                if (pulse) this.formData.pulse = pulse.value;
                if (vitalsNotes) this.formData.vitals_notes = vitalsNotes.value;
                break;
            case 2: // Food Intake
                const intakeLevel = document.getElementById('intake_level');
                const foodNotes = document.getElementById('food_notes');

                if (intakeLevel) this.formData.intake_level = intakeLevel.value;
                if (foodNotes) this.formData.food_notes = foodNotes.value;
                break;
            case 3: // Liquid 1
            case 4: // Liquid 2
            case 5: // Liquid 3
                const liquidNum = step.id - 2;
                const liquidType = document.getElementById(`liquid${liquidNum}_type`);
                const liquidAmount = document.getElementById(`liquid${liquidNum}_amount`);
                const liquidNotes = document.getElementById(`liquid${liquidNum}_notes`);

                if (liquidType) this.formData[`liquid${liquidNum}_type`] = liquidType.value;
                if (liquidAmount) this.formData[`liquid${liquidNum}_amount`] = liquidAmount.value;
                if (liquidNotes) this.formData[`liquid${liquidNum}_notes`] = liquidNotes.value;
                break;
            case 6: // Bowel Movement
                const bowelSize = document.getElementById('bowel_size');
                const bowelConsistency = document.getElementById('bowel_consistency');
                const bowelNotes = document.getElementById('bowel_notes');

                if (bowelSize) this.formData.bowel_size = bowelSize.value;
                if (bowelConsistency) this.formData.bowel_consistency = bowelConsistency.value;
                if (bowelNotes) this.formData.bowel_notes = bowelNotes.value;
                break;
            case 7: // Urine Output
                const urineOutput = document.getElementById('urine_output');
                const urineNotes = document.getElementById('urine_notes');

                if (urineOutput) this.formData.urine_output = urineOutput.value;
                if (urineNotes) this.formData.urine_notes = urineNotes.value;
                break;
        }
    }

    nextStep() {
        this.saveCurrentStep();
        if (this.currentStep < this.totalSteps) {
            this.currentStep++;
            this.renderStep();
            this.updateProgress();
        }
    }

    prevStep() {
        this.saveCurrentStep();
        if (this.currentStep > 1) {
            this.currentStep--;
            this.renderStep();
            this.updateProgress();
        }
    }

    skipStep() {
        if (this.currentStep < this.totalSteps) {
            this.currentStep++;
            this.renderStep();
            this.updateProgress();
        }
    }

    async submitForm() {
        this.saveCurrentStep();

        try {
            const formData = new FormData();
            formData.append('meal_type', this.currentMeal);
            formData.append('form_data', JSON.stringify(this.formData));

            const csrfToken = document.querySelector('[name=csrf_token]')?.value;
            if (csrfToken) {
                formData.append('csrf_token', csrfToken);
            }

            const response = await fetch(`/resident/{{ resident.id }}/logs`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('Daily log submitted successfully!');
                location.reload();
            } else {
                alert('Error submitting form. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error submitting form. Please try again.');
        }
    }
}

// Initialize wizard
const wizard = new DailyLogWizard();

function openMealWizard(meal) {
    wizard.startWizard(meal);
    const modal = new bootstrap.Modal(document.getElementById('mealWizardModal'));
    modal.show();
}

// Add CSRF token meta tag if it doesn't exist
document.addEventListener('DOMContentLoaded', function() {
    if (!document.querySelector('meta[name="csrf-token"]')) {
        const meta = document.createElement('meta');
        meta.name = 'csrf-token';
        meta.content = '{{ csrf_token() }}';
        document.head.appendChild(meta);
    }
});
</script>
{% endblock %}
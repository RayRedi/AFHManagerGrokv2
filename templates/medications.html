{% if not request.headers.get('X-Requested-With') %}
{% extends "base.html" %}
{% block title %}Medications - {{ resident.name if resident else 'Unknown Resident' }}{% endblock %}
{% block content %}
{% endif %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 fw-bold text-dark">Medications for {{ resident.name if resident else 'Unknown Resident' }}</h1>
        <p class="lead text-muted">Manage medications and dosage schedules.</p>
        {% if not resident %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Warning: No resident data found. Please check the URL and try again.
            </div>
        {% endif %}
    </div>
</div>

<!-- Add New Medication Wizard Button -->
<div class="card shadow-sm mb-4">
    <div class="card-body text-center py-4">
        <h3 class="card-title fw-bold text-dark mb-3">
            <i class="fas fa-pills me-2 text-primary"></i>Add New Medication
        </h3>
        <p class="text-muted mb-4">Use our guided wizard to add medications with proper dosing and scheduling</p>
        <button type="button" class="btn btn-primary btn-lg px-4 py-3" id="startWizardBtn" data-bs-toggle="modal" data-bs-target="#medicationWizardModal" style="background: linear-gradient(135deg, #6b48ff 0%, #8b5cf6 100%); border: none; font-weight: 600; font-size: 1.1rem;">
            <i class="fas fa-magic me-2"></i>Start Medication Wizard
        </button>
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Search from our database of medications or add custom entries
            </small>
        </div>
    </div>
</div>

<!-- Medication Wizard Modal -->
<div class="modal fade" id="medicationWizardModal" tabindex="-1" aria-labelledby="medicationWizardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="medicationWizardModalLabel">Add New Medication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Progress Bar -->
                <div class="progress mb-4" style="height: 30px;" id="wizardProgress">
                    <div class="progress-bar" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
                        <span id="progressText">Step 1 of 5</span>
                    </div>
                </div>

                <!-- Wizard Steps Container -->
                <div id="stepContent">
                    <!-- Step content will be populated by JavaScript -->
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </button>
                    <div>
                        <button type="button" class="btn btn-outline-primary me-2" id="skipBtn">Skip Step</button>
                        <button type="button" class="btn btn-primary" id="nextBtn" style="background: linear-gradient(135deg, #6b48ff 0%, #8b5cf6 100%); border: none;">
                            Next<i class="fas fa-arrow-right ms-2"></i>
                        </button>
                        <button type="button" class="btn btn-success" id="saveBtn" style="display: none; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none;">
                            <i class="fas fa-save me-2"></i>Save Medication
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Dose -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h3 class="card-title fw-bold text-dark">Log Dose</h3>
        <form method="POST" action="{{ url_for('medications', resident_id=resident.id) }}">
            {{ log_form.hidden_tag() }}
            <div class="row">
                <div class="col-12 col-md-6 mb-3">
                    <label for="medication_id" class="form-label">Medication</label>
                    {{ log_form.medication_id(class="form-control") }}
                </div>
                <div class="col-12 col-md-6 mb-3">
                    <label for="time" class="form-label">Time</label>
                    {{ log_form.time(class="form-control", placeholder="HH:MM") }}
                </div>
            </div>
            {{ log_form.submit(class="btn btn-primary btn-lg w-100", style="background: #00c4b4; border: none;", value="Log Dose") }}
            <input type="hidden" name="log_dose" value="1">
        </form>
    </div>
</div>

<!-- Medication List -->
<div class="card shadow-sm">
    <div class="card-body">
        <h3 class="card-title fw-bold text-dark">Current Medications</h3>
        {% if medications %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Dosage</th>
                            <th>Frequency</th>
                            <th>Start Date</th>
                            <th>Expiration Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med in medications %}
                            <tr>
                                <td class="fw-semibold">{{ med.name }}</td>
                                <td>{{ med.dosage or 'Not specified' }}</td>
                                <td>{{ med.frequency or 'Not specified' }}</td>
                                <td>{{ med.start_date.strftime('%Y-%m-%d') if med.start_date else 'Not set' }}</td>
                                <td>{{ med.end_date.strftime('%Y-%m-%d') if med.end_date else 'Not set' }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('medications', resident_id=resident.id) }}" style="display: inline;">
                                        {{ csrf_token() }}
                                        <input type="hidden" name="medication_id" value="{{ med.id }}">
                                        <button type="submit" name="delete_medication" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this medication?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">No medications added yet.</p>
        {% endif %}
    </div>
</div>

<!-- Medication Logs -->
<div class="card shadow-sm mt-4">
    <div class="card-body">
        <h3 class="card-title fw-bold text-dark">Medication Logs</h3>
        {% if medication_logs %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Medication</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in medication_logs %}
                            <tr>
                                <td>{{ log.date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ log.time.strftime('%H:%M') }}</td>
                                <td>{{ medications|selectattr('id', 'equalto', log.medication_id)|first|attr('name') if medications|selectattr('id', 'equalto', log.medication_id)|list else 'Unknown' }}</td>
                                <td>{{ 'Administered' if log.administered else 'Missed' }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">No medication doses logged yet.</p>
        {% endif %}
    </div>
</div>

<script>
class MedicationWizard {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 5;
        this.formData = {};
        this.steps = [
            { id: 1, title: 'Medication Search', required: true },
            { id: 2, title: 'Dosage & Schedule', required: false },
            { id: 3, title: 'Dates & Duration', required: true },
            { id: 4, title: 'Additional Information', required: false },
            { id: 5, title: 'Review & Save', required: true }
        ];

        this.initializeWizard();
        this.setupEventListeners();
    }

    initializeWizard() {
        const modal = document.getElementById('medicationWizardModal');
        if (!modal) {
            console.error('Medication wizard modal not found');
            return;
        }

        // Initialize autocomplete when wizard opens
        modal.addEventListener('shown.bs.modal', () => {
            this.showStep(1);
            this.updateProgress();
            // Initialize autocomplete for medication search
            setTimeout(() => {
                this.initializeWizardAutocomplete();
            }, 300);
        });

        // Reset wizard when modal closes
        modal.addEventListener('hidden.bs.modal', () => {
            this.resetWizard();
        });
    }

    setupEventListeners() {
        document.getElementById('nextBtn').addEventListener('click', () => this.nextStep());
        document.getElementById('prevBtn').addEventListener('click', () => this.prevStep());
        document.getElementById('skipBtn').addEventListener('click', () => this.nextStep());
        document.getElementById('saveBtn').addEventListener('click', () => this.saveMedication());
    }

    showStep(step) {
        this.currentStep = step;
        const stepContent = document.getElementById('stepContent');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const skipBtn = document.getElementById('skipBtn');
        const saveBtn = document.getElementById('saveBtn');

        if (!stepContent) {
            console.error('Step content container not found');
            return;
        }

        // Show/hide navigation buttons
        if (prevBtn) prevBtn.style.display = step > 1 ? 'block' : 'none';

        if (step === this.totalSteps) {
            if (nextBtn) nextBtn.style.display = 'none';
            if (skipBtn) skipBtn.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'block';
        } else {
            if (nextBtn) nextBtn.style.display = 'block';
            if (skipBtn) skipBtn.style.display = this.steps[step - 1].required ? 'none' : 'block';
            if (saveBtn) saveBtn.style.display = 'none';
        }

        // Generate step content
        stepContent.innerHTML = this.getStepContent(step);
        this.updateProgress();

        // Populate form with existing data
        setTimeout(() => {
            this.populateStepData(step);
        }, 100);
    }

    getStepContent(step) {
        switch(step) {
            case 1:
                return `
                    <h4><span class="step-number">1</span>Search & Select Medication</h4>
                    <div class="position-relative mb-3">
                        <label for="wizard-med-search" class="form-label fw-semibold">
                            Medication Name <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control form-control-lg" id="wizard-med-search" 
                                   placeholder="Type medication name..." autocomplete="off">
                        </div>
                        <div id="wizard-medication-dropdown" class="dropdown-suggestions border rounded shadow-sm bg-white position-absolute w-100" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                    </div>

                    <div id="wizard-medication-details" class="medication-preview mb-4" style="display: none;">
                        <div class="alert alert-info">
                            <h6 class="mb-2"><i class="fas fa-info-circle me-1"></i>Medication Details</h6>
                            <div id="wizard-details-content"></div>
                        </div>
                    </div>
                `;

            case 2:
                return `
                    <h4><span class="step-number">2</span>Dosage & Schedule</h4>
                    <div class="mb-3">
                        <label for="wizard-dosage" class="form-label fw-semibold">
                            Dosage <span class="text-muted">(optional)</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-pills text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="wizard-dosage" 
                                   placeholder="e.g., 10 mg, 1 tablet">
                        </div>
                        <small class="text-muted">Amount per dose</small>
                    </div>

                    <!-- Frequency Selection with Time Presets -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">
                            Frequency & Times <span class="text-danger">*</span>
                        </label>
                        <div class="frequency-buttons mb-3">
                            <button type="button" class="btn btn-outline-primary frequency-btn" 
                                    data-frequency="once-daily" data-times="1">Once Daily</button>
                            <button type="button" class="btn btn-outline-primary frequency-btn" 
                                    data-frequency="twice-daily" data-times="2">Twice Daily (BID)</button>
                            <button type="button" class="btn btn-outline-primary frequency-btn" 
                                    data-frequency="three-times-daily" data-times="3">Three Times Daily (TID)</button>
                            <button type="button" class="btn btn-outline-primary frequency-btn" 
                                    data-frequency="four-times-daily" data-times="4">Four Times Daily (QID)</button>
                            <button type="button" class="btn btn-outline-primary frequency-btn" 
                                    data-frequency="as-needed" data-times="0">As Needed (PRN)</button>
                        </div>

                        <!-- Time Pickers Container -->
                        <div id="wizard-time-pickers-container" class="time-pickers" style="display: none;">
                            <h6 class="fw-semibold mb-3">
                                <i class="fas fa-clock me-2"></i>Administration Times
                            </h6>
                            <div class="row" id="wizard-time-inputs">
                                <!-- Time inputs will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Hidden frequency input for form submission -->
                        <input type="hidden" id="wizard-frequency" name="frequency">
                    </div>


                `;

            case 3:
                return `
                    <h4><span class="step-number">3</span>Dates & Duration</h4>
                    <div class="row">
                        <div class="col-12 col-md-6 mb-3">
                            <label for="wizard-start-date" class="form-label fw-semibold">
                                Start Date <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-calendar-plus text-muted"></i>
                                </span>
                                <input type="date" class="form-control" id="wizard-start-date" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 mb-3">
                            <label for="wizard-end-date" class="form-label fw-semibold">
                                Expiration Date <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-calendar-minus text-muted"></i>
                                </span>
                                <input type="date" class="form-control" id="wizard-end-date" required>
                            </div>
                        </div>
                    </div>
                `;

            case 4:
                return `
                    <h4><span class="step-number">4</span>Additional Information</h4>
                    <div class="mb-3">
                        <label for="wizard-common-uses" class="form-label fw-semibold">
                            Condition/Uses <span class="text-muted">(optional)</span>
                        </label>
                        <textarea class="form-control" id="wizard-common-uses" rows="3" 
                                  placeholder="What condition is this medication treating?"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="wizard-notes" class="form-label fw-semibold">
                            Notes <span class="text-muted">(optional)</span>
                        </label>
                        <textarea class="form-control" id="wizard-notes" rows="3" 
                                  placeholder="Any special instructions, side effects to watch for, etc."></textarea>
                    </div>
                `;

            case 5:
                return `
                    <h4><span class="step-number">5</span>Review & Save</h4>
                    <div class="alert alert-light">
                        <h6 class="fw-bold mb-3">Please review the medication information:</h6>
                        <div id="review-content">
                            <!-- Review content will be populated -->
                        </div>
                        <hr>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            You can use the "Back" button to make changes before saving.
                        </small>
                    </div>
                `;

            default:
                return '<p>Invalid step</p>';
        }
    }

    populateStepData(step) {
        // Populate form fields with existing data
        switch(step) {
            case 1:
                if (this.formData.name) {
                    document.getElementById('wizard-med-search').value = this.formData.name;
                }
                break;
            case 2:
                if (this.formData.dosage) document.getElementById('wizard-dosage').value = this.formData.dosage;
                if (this.formData.frequency) document.getElementById('wizard-frequency').value = this.formData.frequency;

                // Initialize frequency and time picker functionality
                this.initializeWizardFrequency();

                // Restore selected frequency if exists
                if (this.formData.selectedFrequency) {
                    const selectedBtn = document.querySelector(`[data-frequency="${this.formData.selectedFrequency}"]`);
                    if (selectedBtn) {
                        selectedBtn.click();
                        // Restore time values
                        if (this.formData.medicationTimes) {
                            this.formData.medicationTimes.forEach((time, index) => {
                                const timeInput = document.getElementById(`wizard-medication_time_${index + 1}`);
                                if (timeInput) timeInput.value = time;
                            });
                        }
                    }
                }
                break;
            case 3:
                if (this.formData.start_date) document.getElementById('wizard-start-date').value = this.formData.start_date;
                if (this.formData.end_date) document.getElementById('wizard-end-date').value = this.formData.end_date;
                break;
            case 4:
                if (this.formData.common_uses) document.getElementById('wizard-common-uses').value = this.formData.common_uses;
                if (this.formData.notes) document.getElementById('wizard-notes').value = this.formData.notes;
                break;
            case 5:
                this.showReview();
                break;
        }
    }

    saveStepData(step) {
        // Save current step data
        switch(step) {
            case 1:
                this.formData.name = document.getElementById('wizard-med-search').value;
                break;
            case 2:
                this.formData.dosage = document.getElementById('wizard-dosage').value;
                this.formData.frequency = document.getElementById('wizard-frequency').value;

                // Save selected frequency type and times
                const selectedFrequencyBtn = document.querySelector('.frequency-btn.btn-primary');
                if (selectedFrequencyBtn) {
                    this.formData.selectedFrequency = selectedFrequencyBtn.dataset.frequency;
                }

                // Save medication times
                const timeInputs = document.querySelectorAll('.wizard-medication-time');
                this.formData.medicationTimes = Array.from(timeInputs).map(input => input.value);
                break;
            case 3:
                this.formData.start_date = document.getElementById('wizard-start-date').value;
                this.formData.end_date = document.getElementById('wizard-end-date').value;
                break;
            case 4:
                this.formData.common_uses = document.getElementById('wizard-common-uses').value;
                this.formData.notes = document.getElementById('wizard-notes').value;
                break;
        }
    }

    showReview() {
        const reviewContent = document.getElementById('review-content');
        reviewContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Medication Name:</strong><br>
                    <span class="${this.formData.name ? 'text-dark' : 'text-muted'}">${this.formData.name || 'Not specified'}</span>
                </div>
                <div class="col-md-6">
                    <strong>Dosage:</strong><br>
                    <span class="${this.formData.dosage ? 'text-dark' : 'text-muted'}">${this.formData.dosage || 'Not specified'}</span>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <strong>Frequency:</strong><br>
                    <span class="${this.formData.frequency ? 'text-dark' : 'text-muted'}">${this.formData.frequency || 'Not specified'}</span>
                </div>
                <div class="col-md-6">
                    <strong>Administration Times:</strong><br>
                    <span class="${this.formData.medicationTimes && this.formData.medicationTimes.length ? 'text-dark' : 'text-muted'}">
                        ${this.formData.medicationTimes && this.formData.medicationTimes.length ? 
                          this.formData.medicationTimes.filter(time => time).join(', ') : 
                          'Not specified'}
                    </span>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <strong>Start Date:</strong><br>
                    <span class="${this.formData.start_date ? 'text-dark' : 'text-muted'}">${this.formData.start_date || 'Not set'}</span>
                </div>
                <div class="col-md-6">
                    <strong>Expiration Date:</strong><br>
                    <span class="${this.formData.end_date ? 'text-dark' : 'text-muted'}">${this.formData.end_date || 'Not set'}</span>
                </div>
            </div>
            ${this.formData.common_uses || this.formData.notes ? '<hr>' : ''}
            ${this.formData.common_uses ? `
                <div class="mb-2">
                    <strong>Condition/Uses:</strong><br>
                    <span class="text-dark">${this.formData.common_uses}</span>
                </div>
            ` : ''}
            ${this.formData.notes ? `
                <div class="mb-2">
                    <strong>Notes:</strong><br>
                    <span class="text-dark">${this.formData.notes}</span>
                </div>
            ` : ''}
        `;
    }

    validateStep(step) {
        switch(step) {
            case 1:
                return !!document.getElementById('wizard-med-search').value.trim();
            case 3:
                const startDate = document.getElementById('wizard-start-date').value;
                const endDate = document.getElementById('wizard-end-date').value;
                return !!(startDate && endDate);
            default:
                return true;
        }
    }

    nextStep() {
        if (!this.validateStep(this.currentStep)) {
            alert('Please fill in all required fields before proceeding.');
            return;
        }

        this.saveStepData(this.currentStep);

        if (this.currentStep < this.totalSteps) {
            this.showStep(this.currentStep + 1);
        }
    }

    prevStep() {
        this.saveStepData(this.currentStep);

        if (this.currentStep > 1) {
            this.showStep(this.currentStep - 1);
        }
    }

    updateProgress() {
        const progressBar = document.querySelector('#wizardProgress .progress-bar');
        const progressText = document.getElementById('progressText');
        const percentage = (this.currentStep / this.totalSteps) * 100;

        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
        progressText.textContent = `Step ${this.currentStep} of ${this.totalSteps}`;
    }

    async saveMedication() {
        this.saveStepData(this.currentStep);

        // Validate required fields
        if (!this.formData.name || !this.formData.start_date || !this.formData.end_date) {
            alert('Please ensure all required fields are filled.');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            formData.append('name', this.formData.name);
            formData.append('dosage', this.formData.dosage || '');
            formData.append('frequency', this.formData.frequency || '');
            formData.append('notes', this.formData.notes || '');
            formData.append('common_uses', this.formData.common_uses || '');
            formData.append('start_date', this.formData.start_date);
            formData.append('end_date', this.formData.end_date);

            // Add medication times
            if (this.formData.medicationTimes && this.formData.medicationTimes.length) {
                this.formData.medicationTimes.forEach((time, index) => {
                    if (time) {
                        formData.append(`medication_time_${index + 1}`, time);
                    }
                });
            }

            formData.append('add_medication', '1');

            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // Close modal and reload page
                bootstrap.Modal.getInstance(document.getElementById('medicationWizardModal')).hide();
                window.location.reload();
            } else {
                alert('Error saving medication. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving medication. Please try again.');
        }
    }

    initializeWizardFrequency() {
        const frequencyButtons = document.querySelectorAll('.frequency-btn');
        const frequencyInput = document.getElementById('wizard-frequency');
        const timePickersContainer = document.getElementById('wizard-time-pickers-container');
        const timeInputsContainer = document.getElementById('wizard-time-inputs');

        // Frequency presets with times
        const frequencyPresets = {
            'once-daily': { label: 'Daily', times: ['07:00'] },
            'twice-daily': { label: 'Twice daily', times: ['07:00', '19:00'] },
            'three-times-daily': { label: 'Three times daily', times: ['07:00', '13:00', '19:00'] },
            'four-times-daily': { label: 'Four times daily', times: ['07:00', '12:00', '16:00', '20:00'] },
            'as-needed': { label: 'As needed', times: [] }
        };

        function createTimeInput(index, presetTime = '') {
            const timeDiv = document.createElement('div');
            timeDiv.className = 'col-6 col-md-3 mb-3';
            timeDiv.innerHTML = `
                <label for="wizard-medication_time_${index}" class="form-label fw-semibold">
                    Time ${index} <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-clock text-muted"></i>
                    </span>
                    <input type="time" class="form-control wizard-medication-time" 
                           name="medication_time_${index}" 
                           id="wizard-medication_time_${index}" 
                           value="${presetTime}"
                           required>
                </div>
            `;
            return timeDiv;
        }

        function updateTimeInputs(frequencyType) {
            // Clear existing time inputs
            timeInputsContainer.innerHTML = '';

            const preset = frequencyPresets[frequencyType];
            const times = preset.times;

            if (times.length > 0) {
                timePickersContainer.style.display = 'block';

                // Create time inputs with presets
                times.forEach((presetTime, index) => {
                    const timeDiv = createTimeInput(index + 1, presetTime);
                    timeInputsContainer.appendChild(timeDiv);
                });

                // Add helpful text about presets
                const helpText = document.createElement('div');
                helpText.className = 'col-12 mb-2';
                helpText.innerHTML = `
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Preset times are automatically filled but can be edited as needed
                    </small>
                `;
                timeInputsContainer.insertBefore(helpText, timeInputsContainer.firstChild);
            } else {
                // Hide time pickers for PRN (As Needed)
                timePickersContainer.style.display = 'none';
            }
        }

        // Add click handlers to frequency buttons
        frequencyButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                // Remove active class from all buttons
                frequencyButtons.forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                });

                // Add active class to clicked button
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-primary');

                // Get frequency data
                const frequencyType = this.getAttribute('data-frequency');
                const preset = frequencyPresets[frequencyType];

                // Update hidden frequency input
                if (preset) {
                    frequencyInput.value = preset.label;
                }

                // Update time inputs with presets
                updateTimeInputs(frequencyType);
            });
        });

        // Auto-select "Once Daily" by default if no frequency is selected
        const defaultButton = document.querySelector('.frequency-btn[data-frequency="once-daily"]');
        if (defaultButton && !frequencyInput.value) {
            defaultButton.click();
        }
    }

    async initializeWizardAutocomplete() {
        const searchInput = document.getElementById('wizard-med-search');
        const dropdown = document.getElementById('wizard-medication-dropdown');

        if (!searchInput || !dropdown) {
            console.log('Wizard autocomplete elements not found');
            return;
        }

        let selectedIndex = -1;

        const searchMedications = async (query) => {
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/medication-suggestions?term=${encodeURIComponent(query)}`);
                const suggestions = await response.json();

                dropdown.innerHTML = '';

                if (suggestions.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'dropdown-suggestion-item text-muted';
                    noResults.innerHTML = '<small>No medications found</small>';
                    dropdown.appendChild(noResults);
                    dropdown.style.display = 'block';
                    return;
                }

                suggestions.forEach((med, index) => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-suggestion-item';
                    item.innerHTML = `
                        <div class="fw-semibold">${med.name}</div>
                        ${med.common_uses ? `<small class="text-muted">${med.common_uses}</small>` : ''}
                    `;

                    item.addEventListener('click', () => {
                        this.selectMedication(med);
                        dropdown.style.display = 'none';
                        selectedIndex = -1;
                    });

                    item.addEventListener('mouseenter', () => {
                        selectedIndex = index;
                        this.updateSelection();
                    });

                    dropdown.appendChild(item);
                });

                dropdown.style.display = 'block';
            } catch (error) {
                console.error('Error fetching medication suggestions:', error);
                dropdown.style.display = 'none';
            }
        };

        searchInput.addEventListener('input', (e) => {
            searchMedications(e.target.value);
        });

        searchInput.addEventListener('keydown', (e) => {
            const items = dropdown.getElementsByClassName('dropdown-suggestion-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                this.updateSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                this.updateSelection();
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex].click();
            } else if (e.key === 'Escape') {
                dropdown.style.display = 'none';
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    }

    updateSelection() {
        const items = document.getElementsByClassName('dropdown-suggestion-item');
        Array.from(items).forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#e9ecef';
            } else {
                item.style.backgroundColor = '';
            }
        });
    }

    selectMedication(med) {
        const searchInput = document.getElementById('wizard-med-search');
        const detailsDiv = document.getElementById('wizard-medication-details');
        const detailsContent = document.getElementById('wizard-details-content');

        if (searchInput) {
            searchInput.value = med.name;
            searchInput.classList.add('is-valid');
        }

        // Store medication data
        this.formData.selectedMedication = med;

        // Show medication details
        if (detailsDiv && detailsContent) {
            detailsContent.innerHTML = `
                <div><strong>Medication:</strong> ${med.name}</div>
                ${med.common_uses ? `<div><strong>Common Uses:</strong> ${med.common_uses}</div>` : ''}
                ${med.dosage ? `<div><strong>Default Dosage:</strong> ${med.dosage}</div>` : ''}
                ${med.frequency ? `<div><strong>Default Frequency:</strong> ${med.frequency}</div>` : ''}
            `;
            detailsDiv.style.display = 'block';
        }
    }
}

// Initialize wizard when page loads
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Check if we're on the medications page
        const modal = document.getElementById('medicationWizardModal');
        const startBtn = document.getElementById('startWizardBtn');
        
        if (modal) {
            console.log('Initializing medication wizard...');
            window.medicationWizard = new MedicationWizard();
            console.log('Medication wizard initialized successfully');
            
            // Add click handler to start button as backup
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    console.log('Wizard button clicked');
                });
            }
        } else {
            console.log('Medication wizard modal not found - skipping initialization');
        }
    } catch (error) {
        console.error('Error initializing medication wizard:', error);
        // Show fallback message
        const startBtn = document.getElementById('startWizardBtn');
        if (startBtn) {
            startBtn.addEventListener('click', function() {
                alert('Medication wizard is loading. Please try again in a moment.');
            });
        }
    }
});
</script>
{% if not request.headers.get('X-Requested-With') %}
{% endblock %}
{% endif %}